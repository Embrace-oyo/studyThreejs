import{n as y,a5 as Q,P as $,e as J,v as ee,a6 as te,O as se,x as ie,H as ae,a7 as oe,M,g as T,a8 as re,w as B,a9 as D,k as G,u as z,h as ne,a4 as he,aa as O,ab as H,ac as le,ad as ce,l as de,r as pe}from"./threejs-R2oN4ICD.js";import{W as ue,C as we,S as me,M as U,D as fe,E as ge,V as u,G as I,R as ve,H as ye,I as xe,J as R,Q as Be,l as N,b as be,m as Se,i as X,c as Z,d as C,F as ke,n as Me,p as Ce,e as _e,q as Pe}from"./vendor-D10xMT_S.js";import{_ as ze}from"../lib/index-xycz1Eof.js";const Ie=""+new URL("../glb/space_discoverer-CnSQ9b_n.glb",import.meta.url).href,Fe=""+new URL("../glb/space_discoverer_wheel-OZ7BM8vj.glb",import.meta.url).href,Ee=""+new URL("../png/terrain1-ChKDK3aj.png",import.meta.url).href;function W(F){return new URL(Object.assign({"../assets/space_discoverer.glb":Ie,"../assets/space_discoverer_wheel.glb":Fe,"../assets/terrain1.png":Ee})[`../assets/${F}`],import.meta.url).href}const g={radius:.65,directionLocal:new u(0,-1.1,0),suspensionStiffness:30,suspensionRestLength:.3,frictionSlip:5,dampingRelaxation:2.3,dampingCompression:4.4,rollInfluence:.01,axleLocal:new u(-1,0,0),maxSuspensionTravel:.3,customSlidingRotationalSpeed:-30,useCustomSlidingRotationalSpeed:!0,suspensionDamping:1,maxSuspensionForce:1e4,engineForce:0,brakeForce:5,steering:0},v=[{stop:0,color:new y("#B0E0E6")},{stop:.25,color:new y("#CD853F")},{stop:.5,color:new y("#EEE8AA")},{stop:.75,color:new y("#bf8040")},{stop:1,color:new y("#666")}],Ve=new Q({color:14540253});new Q({color:16777215,wireframe:!0});class Le{constructor(e){this.parent=e.parent,this.target=e.target,this.callback=e.callback,this.width=this.target.offsetWidth,this.height=this.target.offsetHeight,this.aspect=this.width/this.height,this.camera=new $(75,this.aspect,.1,1e5),this.camera.position.set(0,5,-10),this.scene=new J,this.scene.background=new y("#222"),this.renderer=new ee({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=te,this.target.appendChild(this.renderer.domElement),this.controls=new se(this.camera,this.renderer.domElement),this.controls.target.set(0,0,0),this.controls.update(),this.controls.enablePan=!0,this.controls.enableDamping=!0,this.clock=new ie,this.maxSteerVal=.6,this.maxForce=600,this.brakeForce=5,this.assetsInit()}assetsInit(){this.manager=new ae,this.loader=new oe(this.manager),this.loader.load(W("space_discoverer.glb"),e=>{this.discover=e.scene,this.discover.traverse(s=>{s instanceof M&&(s.castShadow=!0,s.receiveShadow=!0,s.material.side=T)}),this.discover.scale.set(1,1,1),this.discover.position.set(0,-1.5,0)}),this.loader.load(W("space_discoverer_wheel.glb"),e=>{this.discoverWheel=e.scene;const s=new re().setFromObject(this.discoverWheel),i=new B;s.getCenter(i),this.discoverWheel.position.sub(i),this.discoverWheel.scale.set(1,1,1),this.discoverWheel.traverse(n=>{n instanceof M&&(n.castShadow=!0,n.receiveShadow=!0,n.material.side=T)})}),this.manager.onLoad=()=>{console.log("complete"),this.callback(),this.lightInit(),this.particleInit(),this.initWorld(),this.chassisBodyInit(),this.wheelBodyInit(),this.groundInit(),this.followCameraInit(),this.animation(),this.resize()}}lightInit(){const e=new D(15724543,1.5);e.position.set(1,0,1).normalize(),this.scene.add(e);const s=new D(16773103,1.5);s.position.set(-1,0,-1).normalize(),this.scene.add(s);const i=new D(14540253);i.position.set(3,10,4),i.target.position.set(0,0,0),i.castShadow=!0,this.sun=i,this.scene.add(i)}initWorld(){this.world=new ue,this.debug=new we(this.scene,this.world),this.world.broadphase=new me(this.world),this.world.gravity.set(0,-9.8,0),this.world.defaultContactMaterial.friction=0,this.groundMaterial=new U("groundMaterial"),this.wheelMaterial=new U("wheelMaterial"),this.wheelGroundContactMaterial=new fe(this.wheelMaterial,this.groundMaterial,{friction:.3,restitution:0,contactEquationStiffness:1e3}),this.world.addContactMaterial(this.wheelGroundContactMaterial),this.currentMaterial=Ve,this.handler=this.handler.bind(this),document.onkeydown=this.handler,document.onkeyup=this.handler}particleInit(){let e=2e3,s=500,i=100,n=500,t={color:16777215,height:100,radiusX:2.5,radiusZ:2.5,size:100,scale:.25};const p=[],r=[];for(let c=0;c<e;c++){const h=new B((Math.random()-.5)*s,Math.random()*i,(Math.random()-.5)*n);p.push(h.x,h.y,h.z);const d=new y(t.color);r.push(d.r,d.g,d.b)}const a=new G;a.setAttribute("position",new z(p,3)),a.setAttribute("color",new z(r,3));const l=new ne({uniforms:{color:{value:new y(t.color)},height:{value:t.height},elapsedTime:{value:0},radiusX:{value:t.radiusX},radiusZ:{value:t.radiusZ},size:{value:t.size},scale:{value:t.scale}},vertexShader:`
            uniform float radiusX;
            uniform float radiusZ;
            uniform float size;
            uniform float scale;
            uniform float height;
            uniform float elapsedTime;

            void main() {
              vec3 pos = position;
              pos.x += cos((elapsedTime + position.z) * 0.25) * radiusX;
              pos.y = mod(pos.y - elapsedTime, height);
              pos.z += sin((elapsedTime + position.x) * 0.25) * radiusZ;

              vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );

              gl_PointSize = size * ( scale / length( mvPosition.xyz ) );

              gl_Position = projectionMatrix * mvPosition;
            }
          `,fragmentShader:`
            uniform vec3 color;

            void main() {
              gl_FragColor = vec4( color, 1.0 );
            }
          `});this.particleSystem=new he(a,l),this.particleSystem.position.y=-i/2,this.scene.add(this.particleSystem)}chassisBodyInit(){this.chassisShape=new ge(new u(1.25,1,3)),this.chassisBody=new I({mass:150}),this.chassisBody.addShape(this.chassisShape),this.chassisBody.position.set(0,40,0),this.chassisBody.angularVelocity.set(0,0,0),this.chassisBody.initPosition=new u(0,40,0);const e=new O;e.add(this.discover),e.castShadow=!1,e.receiveShadow=!0,this.chassisBody.threemesh=e,this.scene.add(e)}wheelBodyInit(){this.vehicle=new ve({chassisBody:this.chassisBody,indexRightAxis:0,indexUpAxis:1,indexForwardAxis:2}),g.chassisConnectionPointLocal=new u(2,-.65,-.95),this.vehicle.addWheel(g),g.chassisConnectionPointLocal.set(-2,-.65,-.95),this.vehicle.addWheel(g),g.chassisConnectionPointLocal.set(2,-.65,2.35),this.vehicle.addWheel(g),g.chassisConnectionPointLocal.set(-2,-.65,2.35),this.vehicle.addWheel(g),this.vehicle.addToWorld(this.world),this.wheelBodies=[],this.vehicle.wheelInfos.forEach((t,p)=>{const r=t.radius,a=new ye(r,r,r/2,20),l=new I({mass:1,material:this.wheelMaterial}),c=new Be;c.setFromAxisAngle(new u(0,0,1),Math.PI/2),l.addShape(a,new u,c);const h=new O,d=this.discoverWheel.clone();h.add(d),(p==1||p==3)&&d.rotateY(Math.PI),h.castShadow=!1,h.receiveShadow=!0,l.threemesh=h,this.scene.add(h),this.wheelBodies.push(l),this.world.addBody(l)}),this.vehicle.setBrake(5,0),this.vehicle.setBrake(5,1),this.vehicle.setBrake(5,2),this.vehicle.setBrake(5,3),this.vehicle.setSteeringValue(0,2),this.vehicle.setSteeringValue(0,3)}groundInit(){let e=new Image;e.crossOrigin="anonymous",e.src=W("terrain1.png"),e.onload=()=>{const n=document.createElement("canvas"),t=n.getContext("2d");let p,r,a,l=[];n.width=128,n.height=128,t.drawImage(e,0,0,128,128),p=t.getImageData(0,0,128,128).data;for(let h=0;h<128;h=h+1){l.push([]);for(let d=0;d<128;d=d+1)r=h*128+d,a=p[r*4]/255*80,l[h].push(a)}const c=new xe(l,{elementSize:10});this.terrainBody=new I({mass:0}),this.terrainBody.addShape(c),this.terrainBody.position.set(-128*c.elementSize/2,-10,128*c.elementSize/2),this.terrainBody.quaternion.setFromAxisAngle(new u(1,0,0),-Math.PI/2),this.world.addBody(this.terrainBody),this.addVisual(this.terrainBody,"landscape")}}followCameraInit(){this.cameraOffset=new B(0,5,-10),this.carPosition=new B,this.carRotation=new H,this.carPosition.copy(this.vehicle.chassisBody.position),this.carRotation.copy(this.vehicle.chassisBody.quaternion),this.targetPosition=this.carPosition.clone().add(this.cameraOffset),this.camera.position.copy(this.targetPosition),this.camera.lookAt(this.carPosition),this.sun.target=this.vehicle.chassisBody.threemesh}handler(e){let s=e.type=="keyup";if(!(!s&&e.type!=="keydown"))switch(this.vehicle.setBrake(0,0),this.vehicle.setBrake(0,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),e.keyCode){case 38:this.vehicle.applyEngineForce(s?0:-this.maxForce,2),this.vehicle.applyEngineForce(s?0:-this.maxForce,3);break;case 40:this.vehicle.applyEngineForce(s?0:this.maxForce,2),this.vehicle.applyEngineForce(s?0:this.maxForce,3);break;case 66:this.vehicle.setBrake(this.brakeForce,0),this.vehicle.setBrake(this.brakeForce,1),this.vehicle.setBrake(this.brakeForce,2),this.vehicle.setBrake(this.brakeForce,3);break;case 39:this.vehicle.setSteeringValue(s?0:-this.maxSteerVal,2),this.vehicle.setSteeringValue(s?0:-this.maxSteerVal,3);break;case 37:this.vehicle.setSteeringValue(s?0:this.maxSteerVal,2),this.vehicle.setSteeringValue(s?0:this.maxSteerVal,3);break}}updateWheel(){for(let i=0;i<this.vehicle.wheelInfos.length;i++){this.vehicle.updateWheelTransform(i);let n=this.vehicle.wheelInfos[i].worldTransform;this.wheelBodies[i].position.copy(n.position),this.wheelBodies[i].quaternion.copy(n.quaternion)}const e=new u(0,1,0),s=new u;this.chassisBody.quaternion.vmult(e,s),s.y<.05&&(this.chassisBody.position.set(this.chassisBody.initPosition.x,this.chassisBody.initPosition.y,this.chassisBody.initPosition.z),this.chassisBody.velocity.set(0,0,0),this.chassisBody.angularVelocity.set(0,0,0),this.chassisBody.quaternion.set(0,0,0,1))}updateBodies(){this.world.bodies.forEach(e=>{e.threemesh!=null&&(e.threemesh.position.copy(e.position),e.threemesh.quaternion.copy(e.quaternion))})}updateCamera(){this.carPosition.copy(this.vehicle.chassisBody.position),this.carRotation.copy(this.vehicle.chassisBody.quaternion);let e=this.carPosition.clone().add(this.cameraOffset);this.camera.position.lerp(e,.1);let s=new H().setFromEuler(new le(0,this.carRotation.y,0));this.camera.quaternion.slerp(s,.1),this.camera.lookAt(this.carPosition),this.sun.position.copy(this.camera.position),this.sun.position.y+=10}updateCarPosition(){if(!this.chassisBody||!this.terrainBody)return;let e=null;const i=new ce(this.chassisBody.position,new B(0,-1,0)).intersectObject(this.terrainBody.threemesh);i.length>0&&(!e||i[0].distance<e.distance)&&(e=i[0]),e?this.chassisBody.position.y=e.point.y+.5:this.chassisBody.threemesh.position.y=40}animation(){this.renderer.setAnimationLoop(()=>this.animation());const e=this.clock.getElapsedTime();this.particleSystem.material.uniforms.elapsedTime.value=e*1.5,this.controls.update(),this.world.step(1/60),this.updateWheel(),this.updateBodies(),this.updateCamera(),this.renderer.render(this.scene,this.camera)}addVisual(e,s,i=!1,n=!0){let t;e instanceof I&&(t=this.shape2Mesh(e,i,n)),t&&(e.threemesh=t,t.castShadow=i,t.receiveShadow=n,this.scene.add(t))}shape2Mesh(e,s,i){const n=new O;return e.shapes.forEach((t,p)=>{let r,a=new G,l=[],c=[],h=[],d=[],b=new u,S=new u,k=new u,_,q,j=this.currentMaterial.clone();switch(j.vertexColors=!0,t.type){case R.types.BOX:r=new M(new pe(t.halfExtents.x*2,t.halfExtents.y*2,t.halfExtents.z*2),this.currentMaterial);break;case R.types.CYLINDER:t.vertices.map(o=>l.push(o.x,o.y,o.z)),t.faces.forEach(o=>{const w=o[0];for(let m=1;m<o.length-1;m++){const x=o[m],V=o[m+1];c.push(w,x,V)}}),a.setAttribute("position",new de(new Float32Array(l),3)),a.setIndex(c),a.computeBoundingSphere(),a.computeVertexNormals(),r=new M(a,this.currentMaterial);break;case R.types.HEIGHTFIELD:for(let o=0;o<t.data.length-1;o++)for(let w=0;w<t.data[o].length-1;w++)for(let m=0;m<2;m++){t.getConvexTrianglePillar(o,w,m===0),b.copy(t.pillarConvex.vertices[0]),S.copy(t.pillarConvex.vertices[1]),k.copy(t.pillarConvex.vertices[2]),b.vadd(t.pillarOffset,b),S.vadd(t.pillarOffset,S),k.vadd(t.pillarOffset,k),l.push(b.x,b.y,b.z),l.push(S.x,S.y,S.z),l.push(k.x,k.y,k.z);const x=l.length/3-3;c.push(x,x+1,x+2)}a.setAttribute("position",new z(l,3)),a.setIndex(c),a.computeBoundingSphere(),a.computeVertexNormals(),a.computeBoundingBox(),_=a.boundingBox,q=new B().subVectors(_.max,_.min),h=a.attributes.position.array;for(let o=0;o<h.length;o+=9)for(let w=0;w<3;w++){const m=h[o+w*3],x=h[o+w*3+1],V=h[o+w*3+2];let L=1-new B(m,x,V).sub(_.min).divide(q).z;for(let f=0;f<v.length-1;f++){const K=v[f+1].stop-v[f].stop;if(L>=v[f].stop&&L<=v[f+1].stop){const Y=(L-v[f].stop)/K,A=v[f].color.clone().lerp(v[f+1].color,Y);d.push(A.r,A.g,A.b);break}}}a.setAttribute("color",new z(d,3)),r=new M(a,j);break;default:throw"Visual type not recognized: "+t.type}r.receiveShadow=i,r.castShadow=s,r.traverse(o=>{o.isMesh&&(o.castShadow=s,o.receiveShadow=i)});let E=e.shapeOffsets[p],P=e.shapeOrientations[p++];r.position.set(E.x,E.y,E.z),r.quaternion.set(P.x,P.y,P.z,P.w),n.add(r)}),n}resize(){window.addEventListener("resize",()=>{this.width=this.target.offsetWidth,this.height=this.target.offsetHeight,this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)})}destroy(){this.scene.traverse(e=>{var s;e instanceof M&&((s=e.geometry)==null||s.dispose(),Object.values(e.material).forEach(i=>{i&&typeof i.dispose=="function"&&i.dispose()}))}),this.renderer.dispose()}}const Ae={class:"spaceDiscover"},De={class:"load"},Oe={__name:"index",setup(F){const e=N(!1);N(0);let s=null;const i=()=>{e.value=!0};return be(()=>{s=new Le({parent:document.querySelector(".spaceDiscover"),target:document.querySelector(".canvas"),callback:i})}),Se(()=>{s.destroy(),s=null,console.info("%c太空探索-销毁😁","color:#fff;background-color:red")}),(n,t)=>(X(),Z("div",Ae,[t[0]||(t[0]=C("div",{class:"info"},"方向键控制前后左右",-1)),C("div",{class:Pe(["loading",{loadOk:e.value}])},[C("div",De,[(X(),Z(ke,null,Me("LOADING...",(p,r)=>C("span",{key:r,style:Ce("--i:"+r)},_e(p),5)),64))])],2),t[1]||(t[1]=C("div",{class:"canvas"},null,-1))]))}},Te=ze(Oe,[["__scopeId","data-v-b532cb35"]]);export{Te as default};
